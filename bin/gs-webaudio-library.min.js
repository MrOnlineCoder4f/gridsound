"use strict";function gswaSampleGroup(){this.samples=[],this.samplesRev=[],this.updateDuration()}function gswaContext(){this.ctx=new window.AudioContext,this.destination=this.ctx.destination,this.filters=this.createFilters(),this.nbPlaying=0,this.filters.connect(this.destination),this.nodeIn=this.filters.nodeIn,delete this.filters.connect}function gswaSample(t,n){this.wCtx=t,this.wBuffer=n,this.connectedTo=t.nodeIn,this.started=0,this.bufferSources=[],this.onended(function(){}),this.edit(0,0,n.duration),this.bufferDuration=n.duration}function gswaBuffer(t){this.wCtx=t,this.samples=[],this.sample=new gswaSample(t,this)}function gswaFilters(t){this.wCtx=t,this.nodes=[],this.nodeIn=t.ctx.createGain(),this.nodeOut=t.ctx.createGain(),this.nodeIn.connect(this.nodeOut),this.connect(t)}function gswaComposition(t){this.wCtx=t,this.samples=[],this.isPlaying=this.isPaused=!1,this.oldDuration=this.duration=this._startedTime=this._currentTime=0,this._bpm=60,this.fnOnended=this.fnOnpaused=function(){},this.onended=this.onended.bind(this),this._add=this._add.bind(this),this._remove=this._remove.bind(this)}!function(){function t(t){this.bufferSources.splice(this.bufferSources.indexOf(t),1)}window.gswaBufferSample=function(){this.bufferSources=[]},gswaBufferSample.prototype={setContext:function(t){this.ctx=t},setMetadata:function(t){t&&(this.duration=this.duration||t.duration)},setDataFromAudioBuffer:function(t){return this.buffer=t,this.setMetadata(t),t},setDataFromArrayBuffer:function(t){return this.ctx.decodeAudioData(t).then(this.setDataFromAudioBuffer.bind(this))},setDataFromBlob:function(t){var n=this,i=new FileReader;return new Promise(function(e,s){i.onloadend=function(){e(n.setDataFromArrayBuffer(i.result))},i.readAsArrayBuffer(t)})},setDataFromURL:function(t){return fetch(t).then(function(t){return t.arrayBuffer()}).then(this.setDataFromArrayBuffer.bind(this))},connect:function(t){this.connectedTo=t,this.bufferSources.forEach(function(n){n.connect(t)})},disconnect:function(){this.connectedTo=null,this.bufferSources.forEach(function(t){t.disconnect()})},start:function(n,i,e){var s,o=this.ctx,h=this.buffer;if(o&&h)return s=o.createBufferSource(),s.buffer=h,s.onended=t.bind(this,s),s.connect(this.connectedTo),this.bufferSources.push(s),s.start(n||0,i||0,arguments.length>2?e:this.duration),s},stop:function(){this.bufferSources.forEach(function(t){t.onended=null,t.stop()}),this.bufferSources.length=0}}}(),gswaSampleGroup.prototype={stretch:function(t){this.samples.forEach(function(n){n.whenRel*=t}),this.updateDuration()},start:function(t,n,i){var e=this.samples[0];e&&(n=n||0,i=arguments.length>2?i:this.duration,t||(t=e.sample.ctx.currentTime),this.samples.forEach(function(e){var s=e.whenRel-n,o=e.duration,h=e.offset;s<0&&(h-=s,o+=s),o>0&&(o+=Math.min(i-s-o,0),o>0&&e.sample.start(t+s,h,o))}))},stop:function(){this.samples.forEach(function(t){t.sample.stop()})},addSample:function(t){t.offset=t.offset||0,t.duration=t.duration||t.sample.duration,this.samples.push(t),this.samplesRev.push(t)},addSamples:function(t){t.forEach(this.addSample.bind(this))},removeSample:function(t){this.samples.splice(this.samples.indexOf(t),1),this.samplesRev.splice(this.samplesRev.indexOf(t),1)},removeSamples:function(t){t.forEach(this.removeSample.bind(this))},updateDuration:function(){var t=this.samplesRev[0];this.duration=t?t.whenRel+t.duration:0},sortSamples:function(){function t(t,n){return t<n?-1:t>n?1:0}this.samples.sort(function(n,i){return t(n.whenRel,i.whenRel)}),this.samplesRev.sort(function(n,i){return t(i.whenRel+i.duration,n.whenRel+n.duration)})}},gswaContext.prototype={gain:function(t){return arguments.length?(this.filter.gain(t),this):this.filter.gain()},createSample:function(t){var n=new gswaSample(this,t);return t.samples.push(n),n},createBuffer:function(){return new gswaBuffer(this)},createFilters:function(){return new gswaFilters(this)},createComposition:function(){return new gswaComposition(this)}},function(){function t(t,n){for(var i=0,e=0,s=t.length+n.length,o=new Float32Array(s);i<s;)o[i++]=t[e],o[i++]=n[e++];return o}function n(t,n,i){for(var e=0;e<i.length;++e)t.setUint8(n+e,i.charCodeAt(e))}function i(t,n,i){for(var e,s=0;s<i.length;++s,n+=2)e=Math.max(-1,Math.min(i[s],1)),t.setInt16(n,e<0?32768*e:32767*e,!0)}function e(t,n,i){for(var e=0;e<i.length;++e,n+=4)t.setFloat32(n,i[e],!0)}window.gswaEncodeWAV=function(s,o){var h=s.numberOfChannels,r=s.sampleRate,a=o&&o.float32?3:1,u=3===a?32:16,c=u/8,f=h*c,d=2===h?t(s.getChannelData(0),s.getChannelData(1)):s.getChannelData(0),l=new ArrayBuffer(44+d.length*c),p=new DataView(l);return n(p,0,"RIFF"),p.setUint32(4,36+d.length*c,!0),n(p,8,"WAVE"),n(p,12,"fmt "),p.setUint32(16,16,!0),p.setUint16(20,a,!0),p.setUint16(22,h,!0),p.setUint32(24,r,!0),p.setUint32(28,r*f,!0),p.setUint16(32,f,!0),p.setUint16(34,u,!0),n(p,36,"data"),p.setUint32(40,d.length*c,!0),(1===a?i:e)(p,44,d),l}}(),gswaSample.prototype={edit:function(t,n,i){return null!=t&&(this.when=t),null!=n&&(this.offset=n),null!=i&&(this.duration=i),this},connect:function(t){return t=t.nodeIn||t,t instanceof AudioNode&&(this.connectedTo=t,this.bufferSources.forEach(function(n){n.connect(t)})),this},disconnect:function(){return this.connectedTo=null,this.bufferSources.forEach(function(t){t.disconnect()}),this},start:function(t,n,i){if(this.wBuffer.buffer){var e=this.wCtx.ctx.createBufferSource();t=null!=t?t:this.when,n=null!=n?n:this.offset,i=null!=i?i:this.duration,e.buffer=this.wBuffer.buffer,e.onended=this._bsrcOnended.bind(this,e,!0),e.connect(this.connectedTo),this.bufferSources.push(e),e.start(this.wCtx.ctx.currentTime+t,n,i),++this.started,t>0?e.gs__onplayTimeoutId=setTimeout(this._bsrcOnplay.bind(this,e),1e3*t):this._bsrcOnplay(e)}return this},stop:function(){return this.started&&(this.bufferSources.forEach(function(t){t.onended=null,t.stop(0),this._bsrcOnended(t,!1)},this),this.bufferSources.length=0),this},onended:function(t){return this._userOnended=t,this},_bsrcOnplay:function(t){t.gs__isPlaying=!0,++this.wCtx.nbPlaying},_bsrcOnended:function(t,n){clearTimeout(t.gs__onplayTimeoutId),t.gs__isPlaying&&(t.gs__isPlaying=!1,--this.wCtx.nbPlaying),n&&this.bufferSources.splice(this.bufferSources.indexOf(t),1),--this.started,this._userOnended()}},gswaBuffer.prototype={setFile:function(t){var n=this;return new Promise(function(i,e){function s(t){n.wCtx.ctx.decodeAudioData(t,function(t){n._setData(t),i(n)},e)}if(t.name){var o=new FileReader;o.addEventListener("loadend",function(){s(o.result)}),o.readAsArrayBuffer(t)}else s(t)})},_setData:function(t){this.buffer=t,this._setDuration(t.duration)},_setDuration:function(t){function n(n){n.bufferDuration=t,(null==n.duration||n.duration>t)&&(n.duration=t)}this.duration=t,this.samples.forEach(n),n(this.sample)},getPeaks:function(t,n,i,e){i=i||0,e=void 0===e?this.buffer.duration-i:Math.min(e,this.buffer.duration-i);for(var s,o,h,r=0,a=new Array(n),u=this.buffer.getChannelData(t),c=e*this.buffer.sampleRate,f=i*this.buffer.sampleRate,d=c/n,l=~~Math.max(1,d/10);r<n;++r){for(s=f+r*d,o=s+d,h=0;s<o;s+=l)h=Math.max(h,Math.abs(u[~~s]));a[r]=h}return a}},gswaFilters.prototype={connect:function(t){t=t.nodeIn||t,t instanceof AudioNode&&(this.connectedTo=t,this.nodeOut.connect(t))},disconnect:function(){this.nodeOut.disconnect(),this.connectedTo=null},empty:function(){this.nodes.length&&(this.nodes[this.nodes.length-1].disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut),this.nodes=[])},gain:function(t){return arguments.length?void(this.nodeOut.gain.value=t):this.nodeOut.gain.value},pushBack:function(t){if(this.nodes.length){var n=this.nodes[this.nodes.length-1];n.disconnect(),n.connect(t)}else this.nodeIn.disconnect(),this.nodeIn.connect(t);t.connect(this.nodeOut),this.nodes.push(t)},pushFront:function(t){this.nodes.length?(this.nodeIn.disconnect(),this.nodeIn.connect(t),t.connect(this.nodes[0]),this.nodes.unshift(t)):this.pushBack(t)},popBack:function(){var t=this.nodes.pop();if(t)if(t.disconnect(),this.nodes.length){var n=this.nodes[this.nodes.length-1];n.disconnect(),n.connect(this.nodeOut)}else this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut);return t},popFront:function(){var t=this.nodes.shift();return t&&(t.disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodes[0]||this.nodeOut)),t}},gswaComposition.prototype={bpm:function(t){if(!arguments.length)return this._bpm;if(t=Math.max(1,t),t!==this._bpm){var n=this._bpm/60,i=n/(t/60),e=this.currentTime();this.samples.forEach(function(t){t.when*=i}),this.isLooping&&this.loop(this.loopWhen*i,this.loopDuration*i),this._bpm=t,this._updateDuration(),this.currentTime(e*i)}return this},add:function(t){return t.forEach?t.forEach(this._add):this._add(t),this},remove:function(t){return t.forEach?t.forEach(this._remove):this._remove(t),this},getSampleAt:function(t){return this.samples.findIndex(function(n){return n.when+n.duration>t})},update:function(t,n){return"rm"!==n&&this.samples.sort(function(t,n){return t.when<n.when?-1:t.when>n.when?1:0}),this._updateDuration(),this.oldDuration!==this.duration&&this._updateEndTimeout(),this.isPlaying&&(t.stop(),"rm"!==n&&(this.isLooping?this._loopUpdate(t):this._sampleStart(t,0,this.currentTime(),1/0))),this},currentTime:function(t){function n(t){return!i.isLooping||t<i.loopEnd?t:i.loopWhen+(t-i.loopWhen)%i.loopDuration}var i=this;return arguments.length?(this.isPlaying&&this._stop(),this._currentTime=n(Math.max(0,Math.min(t,this.duration))),this.isPlaying&&this._play(),this):this.isPlaying?n(this._currentTime+this.wCtx.ctx.currentTime-this._startedTime):this._currentTime},play:function(){return this.isPlaying||(this.isPlaying=!0,this.isPaused=!1,this._play()),this},stop:function(){return(this.isPlaying||this.isPaused)&&(this._stop(),this.onended()),this},pause:function(){return this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this._currentTime+=this.wCtx.ctx.currentTime-this._startedTime,this._startedTime=0,this._stop(),this.fnOnpaused()),this},onended:function(t){return"function"==typeof t?this.fnOnended=t:(this.isPlaying=this.isPaused=!1,this._startedTime=this._currentTime=0,this.fnOnended()),this},_add:function(t){this.samples.indexOf(t)<0&&(this.samples.push(t),t.composition=this,this.update(t,"ad"))},_remove:function(t){var n=this.samples.indexOf(t);n>-1&&(t.composition=null,this.samples.splice(n,1),this.update(t,"rm"))},_stop:function(){clearTimeout(this._endTimeout),clearTimeout(this._loopTimeout),this.samples.forEach(function(t){t.stop()})},_play:function(){this._startedTime=this.wCtx.ctx.currentTime,this.isLooping?this._loopPlay():this.samples.forEach(function(t){this._sampleStart(t,0,this.currentTime(),1/0)},this),this._updateEndTimeout()},_updateDuration:function(){var t=this.samples[this.samples.length-1];this.duration=t?t.when+t.duration:0},_updateEndTimeout:function(){if(clearTimeout(this._endTimeout),this.isPlaying&&!this.isLooping){var t=this.duration-this.currentTime();this.oldDuration=this.duration,t<=0?this.onended():this._endTimeout=setTimeout(this.onended,1e3*t)}},_sampleStart:function(t,n,i,e){var s=t.when,o=t.offset,h=t.duration,r=s-i;r>-h&&s<e&&(s+h>e&&(h-=s+h-e),r<0&&(o-=r,h+=r,r=0),t.start(r+n,o,h))}},Object.assign(gswaComposition.prototype,{loop:function(t,n){return this.isLooping=t!==!1,this.isLooping?(this.loopWhen=t,this.loopDuration=n,this.loopEnd=t+n):clearTimeout(this._loopTimeout),this.isPlaying&&this.currentTime(this.currentTime()),this},_loopPlay:function(){clearTimeout(this._loopTimeout),this.samples.some(function(t){return!(t.when<this.loopEnd)||void this._sampleStart(t,0,this.currentTime(),this.loopEnd)},this),this.currentTime()>=this.loopWhen?this._loopStart():this._loopTimeout=setTimeout(this._loopStart.bind(this),1e3*(this.loopWhen-this.currentTime()))},_loopStart:function(){this._loopN=Math.ceil(2/this.loopDuration),this._loopNbStarted=1,this._loopTimeout=setInterval(this._loopTimer.bind(this),1e3),this._loopTimer()},_loopRemain:function(){return this._loopNbStarted-(this.wCtx.ctx.currentTime-this._startedTime+this._currentTime-this.loopWhen)/this.loopDuration},_loopTimer:function(){if(this._loopRemain()<this._loopN){var t,n,i=0,e=this.getSampleAt(this.loopWhen);if(e>-1)for(;i++<this._loopN;){for(n=e;(t=this.samples[n])&&t.when<this.loopEnd;++n)this._sampleStart(t,this._loopRemain()*this.loopDuration,this.loopWhen,this.loopEnd);++this._loopNbStarted}}},_loopUpdate:function(t){if(this._sampleStart(t,0,this.currentTime(),this.loopEnd),t.when+t.duration>this.loopWhen&&t.when<this.loopEnd)for(var n=1;n<this._loopRemain();++n)this._sampleStart(t,n*this.loopDuration-(this.currentTime()-this.loopWhen),this.loopWhen,this.loopEnd)}}),gswaComposition.prototype.render=function(){var t,n,i,e,s=this,o=this.duration;if(o)return this.stop(),this.isLooping&&(i=this.loopWhen,e=this.loopDuration),t=this.wCtx.ctx,n=this.wCtx.ctx=new OfflineAudioContext(2,44100*o,44100),this.samples.forEach(function(t){t.stop(),t.connect(n.destination)}),this.currentTime(0),e&&this.loop(!1),this.play(),n.startRendering().then(function(n){var o=new DataView(gswaEncodeWAV(n)),h=new Blob([o],{type:"audio/wav"});return s.wCtx.ctx=t,s.samples.forEach(function(n){n.stop(),n.connect(t.destination)}),e&&s.loop(i,e),h}).catch(function(t){console.error("gs-webaudio-library: composition.render() just failed: "+t)})};