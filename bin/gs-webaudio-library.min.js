"use strict";function gswaSampleGroup(){this.id=++gswaSampleGroup.id,this.parents={},this.samples=[],this.samplesRev=[],this.setBpm(60)}window.gswaBufferSample=function(){this.bufferSources=[]},gswaBufferSample.prototype={setContext:function(t){this.ctx=t},setMetadata:function(t){t&&(this.duration=this.duration||t.duration)},dropData:function(){this.stop(),this.disconnect(),this.buffer=null},setDataFromAudioBuffer:function(t){return this.buffer=t,this.setMetadata(t),t},setDataFromArrayBuffer:function(t){return this.ctx.decodeAudioData(t).then(this.setDataFromAudioBuffer.bind(this))},setDataFromBlob:function(t){var e=this,n=new FileReader;return new Promise(function(s,i){n.onloadend=function(){s(e.setDataFromArrayBuffer(n.result))},n.readAsArrayBuffer(t)})},setDataFromURL:function(t){return fetch(t).then(function(t){return t.arrayBuffer()}).then(this.setDataFromArrayBuffer.bind(this))},connect:function(t){this.connectedTo=t,this.bufferSources.forEach(function(e){e.connect(t)})},disconnect:function(){this.connectedTo=null,this.bufferSources.forEach(function(t){t.disconnect()})},start:function(t,e,n){var s,i=this.ctx,r=this.buffer;if(i&&r)return s=i.createBufferSource(),s.buffer=r,s.onended=this._removeSource.bind(this,s),s.connect(this.connectedTo),this.bufferSources.push(s),s.start(t||0,e||0,arguments.length>2?n:this.duration),s},stop:function(){this.bufferSources.forEach(function(t){t.onended=null,t.stop()}),this.bufferSources.length=0},_removeSource:function(t){this.bufferSources.splice(this.bufferSources.indexOf(t),1)}},function(){function t(t,e){for(var n=0,s=0,i=t.length+e.length,r=new Float32Array(i);n<i;)r[n++]=t[s],r[n++]=e[s++];return r}function e(t,e,n){for(var s=0;s<n.length;++s)t.setUint8(e+s,n.charCodeAt(s))}function n(t,e,n){for(var s,i=0;i<n.length;++i,e+=2)s=Math.max(-1,Math.min(n[i],1)),t.setInt16(e,s<0?32768*s:32767*s,!0)}function s(t,e,n){for(var s=0;s<n.length;++s,e+=4)t.setFloat32(e,n[s],!0)}window.gswaEncodeWAV=function(i,r){var a=i.numberOfChannels,o=i.sampleRate,u=r&&r.float32?3:1,f=3===u?32:16,c=f/8,h=a*c,p=2===a?t(i.getChannelData(0),i.getChannelData(1)):i.getChannelData(0),d=new ArrayBuffer(44+p.length*c),l=new DataView(d);return e(l,0,"RIFF"),l.setUint32(4,36+p.length*c,!0),e(l,8,"WAVE"),e(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,u,!0),l.setUint16(22,a,!0),l.setUint32(24,o,!0),l.setUint32(28,o*h,!0),l.setUint16(32,h,!0),l.setUint16(34,f,!0),e(l,36,"data"),l.setUint32(40,p.length*c,!0),(1===u?n:s)(l,44,p),d}}(),gswaSampleGroup.id=0,gswaSampleGroup.prototype={setBpm:function(t){this.bpm!==t&&(this.bpm=t,this.bps=60/t,this.samples.forEach(function(e){e.source instanceof gswaSampleGroup&&e.source.setBpm(t)}),this._updateDur())},start:function(t,e,n){var s=this.samples[0],i=this.bps;s&&(e=(e||0)*i,n=(arguments.length>2?n:this.duration)*i,(!t||t<0)&&(t=this.ctx.currentTime),this.samples.forEach(function(s){var r=s.source,a=r instanceof gswaSampleGroup?i:1,o=s.beat*i-e,u=s.offset*a,f=null!=s.duration?s.duration:s.source.duration;f*=a,o<0&&(u-=o,f+=o),f>0&&(f+=Math.min(n-o-f,0),f>0&&r.start(t+Math.max(0,o),u/a,f/a))}))},stop:function(){this.samples.forEach(function(t){t.source.stop()})},addSample:function(t){var e=t.source.parents,n=this.id;e&&(e[n]?++e[n].nb:e[n]={obj:this,nb:1}),t.offset=t.offset||0,this.samples.push(t),this.samplesRev.push(t),this.ctx=t.source.ctx},addSamples:function(t){t.forEach(this.addSample.bind(this))},removeSample:function(t){var e=t.source.parents,n=this.samples.indexOf(t);n>0&&(--e[this.id].nb<=0&&delete e[this.id],this.samples.splice(n,1),this.samplesRev.splice(this.samplesRev.indexOf(t),1))},removeSamples:function(t){t.forEach(this.removeSample.bind(this))},update:function(){var t=this.parents;this._sortSmp(),this._updateDur();for(var e in t)t[e].obj.update()},_updateDur:function(){var t=this.samplesRev[0];this.duration=t?this._beatEnd(t):0},_sortSmp:function(){function t(t,e){return t<e?-1:t>e?1:0}var e=this;this.samples.sort(function(e,n){return t(e.beat,n.beat)}),this.samplesRev.sort(function(n,s){return t(e._beatEnd(s),e._beatEnd(n))})},_beatEnd:function(t){var e=null!=t.duration?t.duration:t.source.duration;return t.source instanceof gswaSampleGroup&&(e/=this.bps),t.beat+e}};