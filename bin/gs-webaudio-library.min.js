"use strict";function gswaSampleGroup(){this.parentGroups=[],this.samples=[],this.samplesRev=[],this.setBpm(60)}window.gswaBufferSample=function(){this.bufferSources=[]},gswaBufferSample.prototype={setContext:function(t){this.ctx=t},setMetadata:function(t){t&&(this.duration=this.duration||t.duration)},dropData:function(){this.stop(),this.disconnect(),this.buffer=null},setDataFromAudioBuffer:function(t){return this.buffer=t,this.setMetadata(t),t},setDataFromArrayBuffer:function(t){return this.ctx.decodeAudioData(t).then(this.setDataFromAudioBuffer.bind(this))},setDataFromBlob:function(t){var e=this,n=new FileReader;return new Promise(function(s,r){n.onloadend=function(){s(e.setDataFromArrayBuffer(n.result))},n.readAsArrayBuffer(t)})},setDataFromURL:function(t){return fetch(t).then(function(t){return t.arrayBuffer()}).then(this.setDataFromArrayBuffer.bind(this))},connect:function(t){this.connectedTo=t,this.bufferSources.forEach(function(e){e.connect(t)})},disconnect:function(){this.connectedTo=null,this.bufferSources.forEach(function(t){t.disconnect()})},start:function(t,e,n){var s,r=this.ctx,i=this.buffer;if(r&&i)return s=r.createBufferSource(),s.buffer=i,s.onended=this._removeSource.bind(this,s),s.connect(this.connectedTo),this.bufferSources.push(s),s.start(t||0,e||0,arguments.length>2?n:this.duration),s},stop:function(){this.bufferSources.forEach(function(t){t.onended=null,t.stop()}),this.bufferSources.length=0},_removeSource:function(t){this.bufferSources.splice(this.bufferSources.indexOf(t),1)}},function(){function t(t,e){for(var n=0,s=0,r=t.length+e.length,i=new Float32Array(r);n<r;)i[n++]=t[s],i[n++]=e[s++];return i}function e(t,e,n){for(var s=0;s<n.length;++s)t.setUint8(e+s,n.charCodeAt(s))}function n(t,e,n){for(var s,r=0;r<n.length;++r,e+=2)s=Math.max(-1,Math.min(n[r],1)),t.setInt16(e,s<0?32768*s:32767*s,!0)}function s(t,e,n){for(var s=0;s<n.length;++s,e+=4)t.setFloat32(e,n[s],!0)}window.gswaEncodeWAV=function(r,i){var o=r.numberOfChannels,a=r.sampleRate,u=i&&i.float32?3:1,f=3===u?32:16,c=f/8,h=o*c,p=2===o?t(r.getChannelData(0),r.getChannelData(1)):r.getChannelData(0),l=new ArrayBuffer(44+p.length*c),d=new DataView(l);return e(d,0,"RIFF"),d.setUint32(4,36+p.length*c,!0),e(d,8,"WAVE"),e(d,12,"fmt "),d.setUint32(16,16,!0),d.setUint16(20,u,!0),d.setUint16(22,o,!0),d.setUint32(24,a,!0),d.setUint32(28,a*h,!0),d.setUint16(32,h,!0),d.setUint16(34,f,!0),e(d,36,"data"),d.setUint32(40,p.length*c,!0),(1===u?n:s)(d,44,p),l}}(),gswaSampleGroup.prototype={setBpm:function(t){this.bpm!==t&&(this.bpm=t,this.bps=60/t,this.samples.forEach(function(e){e.source instanceof gswaSampleGroup&&e.source.setBpm(t)}),this._updateDur())},start:function(t,e,n){var s=this.samples[0],r=this.bps;s&&(e=(e||0)*r,n=(arguments.length>2?n:this.duration)*r,(!t||t<0)&&(t=this.ctx.currentTime),this.samples.forEach(function(s){var i=s.source,o=i instanceof gswaSampleGroup?r:1,a=s.beat*r-e,u=s.offset*o,f=null!=s.duration?s.duration:s.source.duration;f*=o,a<0&&(u-=a,f+=a),f>0&&(f+=Math.min(n-a-f,0),f>0&&i.start(t+Math.max(0,a),u/o,f/o))}))},stop:function(){this.samples.forEach(function(t){t.source.stop()})},addSample:function(t){var e=t.source.parentGroups;t.offset=t.offset||0,e&&e.indexOf(this)<0&&e.push(this),this.samples.push(t),this.samplesRev.push(t),this.ctx=t.source.ctx},addSamples:function(t){t.forEach(this.addSample.bind(this))},removeSample:function(t){var e=t.source.parentGroups;this.samples.splice(this.samples.indexOf(t),1),this.samplesRev.splice(this.samplesRev.indexOf(t),1),e&&e.splice(e.indexOf(this),1)},removeSamples:function(t){t.forEach(this.removeSample.bind(this))},update:function(){this._sortSmp(),this._updateDur(),this.parentGroups.forEach(function(t){t.update()})},_updateDur:function(){var t=this.samplesRev[0];this.duration=t?this._beatEnd(t):0},_sortSmp:function(){function t(t,e){return t<e?-1:t>e?1:0}var e=this;this.samples.sort(function(e,n){return t(e.beat,n.beat)}),this.samplesRev.sort(function(n,s){return t(e._beatEnd(s),e._beatEnd(n))})},_beatEnd:function(t){var e=null!=t.duration?t.duration:t.source.duration;return t.source instanceof gswaSampleGroup&&(e/=this.bps),t.beat+e}};