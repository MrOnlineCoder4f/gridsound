"use strict";function gswaSampleGroup(){this.id=++gswaSampleGroup.id,this.parents={},this.samples=[],this.samplesRev=[],this.setBpm(60)}window.gswaBufferSample=function(){this.bufferSources=[]},gswaBufferSample.regFilename=/(?:([^\/]*)\.([a-zA-Z\d]*))?$/,gswaBufferSample.prototype={setContext:function(t){this.ctx=t},setData:function(t){if(t){var e,n=t.name||t;this.data=t,"string"==typeof n&&(e=gswaBufferSample.regFilename.exec(n),this.filename=e[0],this.name=e[1])}},load:function(){var t=this.data;return t instanceof AudioBuffer?Promise.resolve(this._setDataFromAudioBuffer(t)):t instanceof ArrayBuffer?this._setDataFromArrayBuffer(t):t instanceof Blob?this._setDataFromBlob(t):this._setDataFromURL(t)},unload:function(){this.stop(),this.disconnect(),this.buffer=null},connect:function(t){this.connectedTo=t,this.bufferSources.forEach(function(e){e.connect(t)})},disconnect:function(){this.connectedTo=null,this.bufferSources.forEach(function(t){t.disconnect()})},start:function(t,e,n){var s,i=this.ctx,a=this.buffer;if(i&&a)return s=i.createBufferSource(),s.buffer=a,s.onended=this._removeSource.bind(this,s),s.connect(this.connectedTo),this.bufferSources.push(s),s.start(t||0,e||0,arguments.length>2?n:this.duration),s},stop:function(){this.bufferSources.forEach(function(t){t.onended=null,t.stop()}),this.bufferSources.length=0},_removeSource:function(t){this.bufferSources.splice(this.bufferSources.indexOf(t),1)},_setDataFromAudioBuffer:function(t){return this.buffer=t,this.duration=t.duration,t},_setDataFromArrayBuffer:function(t){return this.ctx.decodeAudioData(t).then(this._setDataFromAudioBuffer.bind(this))},_setDataFromBlob:function(t){var e=this,n=new FileReader;return new Promise(function(s,i){n.onloadend=function(){s(e._setDataFromArrayBuffer(n.result))},n.readAsArrayBuffer(t)})},_setDataFromURL:function(t){return fetch(t).then(function(t){return t.arrayBuffer()}).then(this._setDataFromArrayBuffer.bind(this))}},function(){function t(t,e){for(var n=0,s=0,i=t.length+e.length,a=new Float32Array(i);n<i;)a[n++]=t[s],a[n++]=e[s++];return a}function e(t,e,n){for(var s=0;s<n.length;++s)t.setUint8(e+s,n.charCodeAt(s))}function n(t,e,n){for(var s,i=0;i<n.length;++i,e+=2)s=Math.max(-1,Math.min(n[i],1)),t.setInt16(e,s<0?32768*s:32767*s,!0)}function s(t,e,n){for(var s=0;s<n.length;++s,e+=4)t.setFloat32(e,n[s],!0)}window.gswaEncodeWAV=function(i,a){var r=i.numberOfChannels,o=i.sampleRate,u=a&&a.float32?3:1,f=3===u?32:16,h=f/8,c=r*h,l=2===r?t(i.getChannelData(0),i.getChannelData(1)):i.getChannelData(0),p=new ArrayBuffer(44+l.length*h),d=new DataView(p);return e(d,0,"RIFF"),d.setUint32(4,36+l.length*h,!0),e(d,8,"WAVE"),e(d,12,"fmt "),d.setUint32(16,16,!0),d.setUint16(20,u,!0),d.setUint16(22,r,!0),d.setUint32(24,o,!0),d.setUint32(28,o*c,!0),d.setUint16(32,c,!0),d.setUint16(34,f,!0),e(d,36,"data"),d.setUint32(40,l.length*h,!0),(1===u?n:s)(d,44,l),p}}(),gswaSampleGroup.id=0,gswaSampleGroup.prototype={empty:function(){var t=this.id;this.samples.forEach(function(e){delete e.source.parents[t]}),this.samples.length=0,this.samplesRev.length=0,this.update()},setBpm:function(t){this.bpm!==t&&(this.bpm=t,this.bps=60/t,this.samples.forEach(function(e){e.source instanceof gswaSampleGroup&&e.source.setBpm(t)}),this._updateDur())},start:function(t,e,n){var s=this.samples[0],i=this.bps;s&&(e=(e||0)*i,n=(arguments.length>2?n:this.duration)*i,(!t||t<0)&&(t=this.ctx.currentTime),this.samples.forEach(function(s){var a=s.source,r=a instanceof gswaSampleGroup?i:1,o=s.beat*i-e,u=s.offset*r,f=null!=s.duration?s.duration:s.source.duration;f*=r,o<0&&(u-=o,f+=o),f>0&&(f+=Math.min(n-o-f,0),f>0&&a.start(t+Math.max(0,o),u/r,f/r))}))},stop:function(){this.samples.forEach(function(t){t.source.stop()})},addSample:function(t){var e=t.source.parents,n=this.id;e&&(e[n]?++e[n].nb:e[n]={obj:this,nb:1}),t.offset=t.offset||0,this.samples.push(t),this.samplesRev.push(t),this.ctx=t.source.ctx},addSamples:function(t){t.forEach(this.addSample.bind(this))},removeSample:function(t){var e=t.source.parents,n=this.samples.indexOf(t);n>0&&(--e[this.id].nb<=0&&delete e[this.id],this.samples.splice(n,1),this.samplesRev.splice(this.samplesRev.indexOf(t),1))},removeSamples:function(t){t.forEach(this.removeSample.bind(this))},update:function(){var t=this.parents;this._sortSmp(),this._updateDur();for(var e in t)t[e].obj.update()},_updateDur:function(){var t=this.samplesRev[0];this.duration=t?this._beatEnd(t):0},_sortSmp:function(){function t(t,e){return t<e?-1:t>e?1:0}var e=this;this.samples.sort(function(e,n){return t(e.beat,n.beat)}),this.samplesRev.sort(function(n,s){return t(e._beatEnd(s),e._beatEnd(n))})},_beatEnd:function(t){var e=null!=t.duration?t.duration:t.source.duration;return t.source instanceof gswaSampleGroup&&(e/=this.bps),t.beat+e}};